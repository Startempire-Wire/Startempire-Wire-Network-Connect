# SEWN Connect — Deploy & Distribution

> How the Startempire Wire Network Connect plugin is developed, versioned,
> and distributed across the network.

---

## Architecture

```
Workbench (startempirewire.com)
  │  git commit + push
  ▼
GitHub Canonical
  github.com/Startempire-Wire/Startempire-Wire-Network-Connect
  │
  ├─► Local sites  ── CLI git pull (same VPS, cron or manual)
  │
  └─► Remote sites ── REST ping → site self-updates from GitHub
                       (requires SEWN_DEPLOY_DEV_MODE)
```

| Role | Location | Description |
|------|----------|-------------|
| **Canonical** | GitHub `Startempire-Wire/Startempire-Wire-Network-Connect` | Source of truth. All code merges here. |
| **Workbench** | `/home/startempirewire/.../plugins/startempire-wire-network-connect/` | Development copy. Commit and push here. |
| **Mirror** | `/home/wirebot/startempire-wire-network-connect/` | Read-only reference. Pulls from GitHub. |
| **Member sites** | Any WordPress install with SEWN Connect | Receive updates from GitHub via pull or zip download. |

Each repo contains a `.canonical` file describing its role.

---

## Repository Conventions

- **Branch:** `main` (single branch, no feature branches on canonical)
- **Tags:** Semantic versions (`v0.4.0`, `v0.4.3`, etc.)
- **Commits:** Conventional Commits (`feat:`, `fix:`, `chore:`, `docs:`)

### Version Bumps

The version lives in two places in `startempire-wire-network-connect.php`:

```php
* Version:         0.4.3          // Plugin header
define('SEWN_CONNECT_VERSION', '0.4.3');  // PHP constant
```

Update both when releasing.

---

## Admin Panels

### Settings → SEWN Connect (all sites)

Standard plugin configuration: Ring Leader URL, API key, cache TTL,
Scorebaord/Wirebot URLs, overlay toggle.

When `SEWN_DEPLOY_DEV_MODE` is enabled, two additional fields appear:

| Field | Purpose |
|-------|---------|
| **Deploy Secret** | Shared secret for remote deploy pings. Paste the value generated by the workbench. |
| **Daily Auto-Update** | Checkbox. Site independently checks GitHub every 24 hours and self-updates. |

### Settings → SEWN Deploy (workbench only)

Only appears when `sewn_connect_is_workbench` option is `1` (set in DB).

| Section | Always available | Requires DEV MODE |
|---------|:---:|:---:|
| Git status (branch, commit, sync, dirty files) | ✅ | — |
| Recent commits (10) | ✅ | — |
| Push to Canonical (commit + push to GitHub) | ✅ | — |
| Auto-deploy after push | — | ✅ |
| Network Sites registry table | — | ✅ |
| Auto-update toggle per site | — | ✅ |
| Deploy buttons (per-site + bulk) | — | ✅ |
| Add Network Site form | — | ✅ |
| Remote Site Setup instructions | — | ✅ |

---

## SEWN_DEPLOY_DEV_MODE

All auto-download features are gated behind a wp-config.php constant:

```php
define('SEWN_DEPLOY_DEV_MODE', true);
```

**Default: OFF.** Production sites should not enable this. Use standard
WordPress update mechanisms (plugin zip upload, WP-CLI, etc.) instead.

### What it controls

| Feature | OFF (default) | ON |
|---------|:---:|:---:|
| REST `GET /sewn-connect/v1/deploy/status` | Not registered | Active |
| REST `POST /sewn-connect/v1/deploy/pull` | Not registered | Active |
| Daily self-update cron (`sewn_connect_self_update`) | Unscheduled | Scheduled |
| Auto-deploy to sites after Push to Canonical | Skipped | Runs |
| Site registry, deploy buttons, add-site form | Hidden | Shown |
| Deploy Secret + Auto-Update settings fields | Hidden | Shown |
| Zip-from-GitHub download fallback | Disabled | Available |

When dev mode is turned OFF, any previously scheduled self-update cron is
automatically unscheduled on the next page load.

---

## Deployment Methods

### 1. Local Sites (same server)

Sites on the same VPS as the workbench. Updated via `git pull` on the
filesystem.

**CLI script:** `/usr/local/bin/sewn-connect-deploy`

```bash
# Deploy all enabled local sites + mirrors
sewn-connect-deploy

# Deploy a specific site by slug (force, bypasses enabled check)
sewn-connect-deploy podcastforge-com
```

**Cron:** `/etc/cron.d/sewn-connect-deploy` — runs daily at 3 AM PST.

**Log:** `/var/log/sewn-connect-deploy.log`

The script reads the site registry from the workbench DB
(`sewn_connect_deploy_sites` option) and only deploys sites with
`type: local` and `enabled: true`.

### 2. Remote Sites (any server)

Sites on external hosting. The workbench sends a REST ping; the remote
site downloads the latest code from GitHub itself.

**Flow:**

1. Workbench `POST`s to `https://remote-site.com/wp-json/sewn-connect/v1/deploy/pull`
   with `X-SEWN-Deploy-Secret` header.
2. Remote site receives the ping, verifies the secret.
3. Remote site updates itself:
   - If `.git` exists: `git fetch origin main && git reset --hard origin/main`
   - If no `.git`: downloads zip from `github.com/.../archive/refs/heads/main.zip`,
     extracts, and replaces plugin files.
4. Returns result JSON to workbench.

**Requirements on the remote site:**

- SEWN Connect plugin installed
- `SEWN_DEPLOY_DEV_MODE` enabled in `wp-config.php`
- Deploy secret set in Settings → SEWN Connect

### 3. Independent Self-Update (any site)

Any site with SEWN Connect can opt into daily self-updates that work
without any workbench involvement.

1. Enable `SEWN_DEPLOY_DEV_MODE` in `wp-config.php`
2. Check "Daily Auto-Update" in Settings → SEWN Connect
3. WP-Cron fires `sewn_connect_self_update` daily
4. Site pulls latest from GitHub (git or zip method)

---

## Site Registry Format

Stored in `wp_options` as `sewn_connect_deploy_sites` (serialized array).

```json
{
  "podcastforge-com": {
    "url": "https://podcastforge.com",
    "label": "Podcast Forge",
    "type": "local",
    "enabled": true,
    "deploy_secret": "YkvZtt1b...",
    "local_path": "/home/podcastforge/public_html/wp-content/plugins/startempire-wire-network-connect",
    "last_deploy": "2026-02-08 17:30:00",
    "last_commit": "3844958",
    "last_status": null,
    "added": "2026-02-08 17:15:00"
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `url` | string | Full site URL. Used as display + REST endpoint base for remote sites. |
| `label` | string | Friendly name shown in admin table. |
| `type` | `local` \| `remote` | Deployment method. |
| `enabled` | bool | Auto-update toggle. When OFF, site is skipped during deploy-all. |
| `deploy_secret` | string | 48-char random string. Auto-generated when adding a site. Must be pasted into the remote site's settings. |
| `local_path` | string | Absolute filesystem path (local sites only). Falls back to CLI script if empty. |
| `last_deploy` | datetime | Timestamp of last successful deploy from this workbench. |
| `last_commit` | string | Short git hash or version string after last deploy. |
| `last_status` | array\|null | Last response from `/deploy/status` (remote sites). |
| `added` | datetime | When the site was added to the registry. |

### Slug Generation

Slugs are derived from the URL:

```
https://podcastforge.com → podcastforge-com
https://my.cool-site.io  → my-cool-site-io
```

---

## REST Endpoints

Registered on every site when `SEWN_DEPLOY_DEV_MODE` is `true`.
Authenticated via `X-SEWN-Deploy-Secret` header matching the
`sewn_connect_deploy_secret` option.

### GET /sewn-connect/v1/deploy/status

Returns current plugin state.

```json
{
  "site_url": "https://podcastforge.com",
  "version": "0.4.3",
  "commit": "3844958",
  "has_git": true,
  "auto_update": false,
  "php_version": "8.3.30",
  "wp_version": "6.9.1",
  "checked_at": "2026-02-08T17:30:17-08:00"
}
```

### POST /sewn-connect/v1/deploy/pull

Triggers self-update. Returns result:

```json
{
  "success": true,
  "method": "git",
  "before": "800bc47",
  "after": "3844958",
  "updated": true,
  "output": "..."
}
```

Or for zip method:

```json
{
  "success": true,
  "method": "zip",
  "version": "0.4.3",
  "updated": true
}
```

**Auth failure** (no secret, wrong secret): Returns standard WP REST
`401` / `404` — endpoint existence is not revealed.

---

## Adding a New Network Site

### On the Workbench

1. Go to **Settings → SEWN Deploy**
2. Scroll to **➕ Add Network Site**
3. Enter the site URL and a friendly label
4. Choose type:
   - **Remote** (default) — for sites on other servers
   - **Local** — for sites on this same VPS
5. Click **Add Site & Generate Deploy Secret**
6. Copy the deploy secret shown in the success banner

### On the Member Site

1. Install SEWN Connect plugin (upload zip from GitHub releases, or `git clone`)
2. Add to `wp-config.php`:
   ```php
   define('SEWN_DEPLOY_DEV_MODE', true);
   ```
3. Go to **Settings → SEWN Connect**
4. Configure Ring Leader URL, API key, etc.
5. Paste the **Deploy Secret** from the workbench
6. Optionally enable **Daily Auto-Update**
7. Save

### Verify

From the workbench, click the **⬆ Deploy** button next to the new site.
The result banner should show success. The site's version/commit in the
table should turn green and match the workbench.

---

## CLI Reference

### sewn-connect-deploy

```bash
# Deploy all enabled local sites + mirrors
sewn-connect-deploy

# Deploy specific site by registry slug
sewn-connect-deploy podcastforge-com
```

Reads site registry from workbench DB. Only processes `type: local` sites.
Remote sites are handled by the admin panel via REST.

**Environment:** Runs as root. Uses `--allow-root` for WP-CLI. Fixes
file ownership after git operations based on the home directory user.

### Cron

```
# /etc/cron.d/sewn-connect-deploy
0 3 * * * root /usr/local/bin/sewn-connect-deploy >> /var/log/sewn-connect-deploy.log 2>&1
```

---

## DB Options Reference

| Option | Where | Description |
|--------|-------|-------------|
| `sewn_connect_is_workbench` | Workbench only | `1` to show the Deploy admin panel |
| `sewn_connect_deploy_sites` | Workbench only | Site registry (JSON/serialized array) |
| `sewn_connect_deploy_secret` | Member sites | Shared secret for deploy ping auth |
| `sewn_connect_auto_update` | Member sites | `1` to enable daily self-update cron |
| `sewn_connect_deploy_version` | Any site | Last known version after self-update |

---

## Security Notes

- Deploy secrets are 48-character random strings (no special chars).
- REST endpoints return 404 (not 401) when no secret is configured —
  endpoint existence is not revealed to unauthenticated requests.
- `SEWN_DEPLOY_DEV_MODE` is OFF by default. No auto-download code runs
  on production sites unless explicitly opted in via wp-config.php.
- The self-update mechanism uses `download_url()` and `unzip_file()` —
  standard WordPress filesystem functions that respect `FS_METHOD`.
- Git operations use `git reset --hard` which discards local changes.
  This is intentional — member sites should not have local modifications.

---

## File Map

```
startempire-wire-network-connect/
├── .canonical                  # Role marker (WORKBENCH or MIRROR)
├── startempire-wire-network-connect.php  # Main plugin file
├── admin/
│   ├── class-admin.php         # Settings → SEWN Connect page
│   └── class-deploy.php        # Settings → SEWN Deploy page + REST endpoints + self-update
├── inc/
│   ├── class-ring-leader-client.php  # Ring Leader API client
│   └── class-rest-api.php      # sewn-connect/v1/* REST endpoints
├── public/
│   └── class-startempire-wire-network-connect-public.php  # Frontend (overlay, BP button)
├── assets/js/
│   └── sewn-overlay.js         # Wirebot overlay widget (1486 lines)
├── docs/
│   ├── DEPLOY.md               # This file
│   └── GROWTH-PARTNERS-SCAFFOLD.md  # Growth Partners feature spec
└── readme.txt                  # WordPress.org readme
```

---

## Version History

| Version | Commit | Changes |
|---------|--------|---------|
| v0.4.3 | `3844958` | Gate auto-deploy behind `SEWN_DEPLOY_DEV_MODE` |
| v0.4.2 | `800bc47` | Platform-agnostic deploy (remote REST + local git) |
| v0.4.1 | `0e678be` | Deploy Manager admin panel |
| v0.4.0 | `bc98410` | Reconciled fork, tagged canonical. `.canonical` markers. |
| v0.3.1 | `e023388` | Drift bar + R.A.B.I.T. alerts in overlay |
| v0.3.0 | `637132f` | Wirebot overlay widget |
| v0.2.0 | `402bd8b` | Ring Leader client, REST API, admin, shortcodes |
